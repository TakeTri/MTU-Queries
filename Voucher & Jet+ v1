WITH
  AllJetPlusOrders AS (
    SELECT
      fo.restaurantid,
      date_trunc(fo.orderdatetime, DAY) AS orderdate,
      SUM(fo.nroforders) AS all_jet_plus_orders
      -- Removed ufd_orders and its dependent joins (dim_benefit, bridge_order_benefit)
    FROM
      `just-data-warehouse.core_dwh.fact_order` AS fo
    INNER JOIN
      `just-data-warehouse.dwh.dim_order` AS ddo
      ON fo.orderid = ddo.orderid
    INNER JOIN
      `just-data-warehouse.datamart_mis_jet_plus.jet_plus_active_memberships_v2` AS am
      ON ddo.global_user_id = am.global_user_id
      AND DATE(fo.orderdatetime) = am.snapshot_date
    WHERE
      fo.orderdatetime >= "2024-06-01"
      AND ddo.orderday >= "2024-06-01"
      AND fo.orderdatetime BETWEEN am.membership_start_date AND LEAST(am.membership_cancel_date, am.membership_expiry_date)
    GROUP BY
      1, 2
  ),

  RawOrderStats AS (
    SELECT
      dcountry.country AS original_country,
      date_trunc(fo.orderdatetime, DAY) AS orderdate,
      fo.restaurantid,
      MAX(COALESCE(ajpo.all_jet_plus_orders, 0)) AS all_jet_plus_orders,
      SUM(ABS(fom.rpo_voucher_amount)) AS total_vouchercost

    FROM
      `just-data-warehouse.core_dwh.fact_order` AS fo
    LEFT JOIN
      `just-data-warehouse.dwh.dim_country` AS dcountry
      ON dcountry.countryid = fo.countryid

    LEFT JOIN
      `just-data-warehouse.core_dwh.fact_order_margin` AS fom
      ON fo.orderid = fom.order_id
    LEFT JOIN
      AllJetPlusOrders AS ajpo
      ON fo.restaurantid = ajpo.restaurantid AND date_trunc(fo.orderdatetime, DAY) = ajpo.orderdate
    WHERE
      fo.orderdatetime >= "2024-06-01"
      AND fom.order_date_time_utc >= "2024-06-01"
    GROUP BY
      dcountry.country,
      orderdate,
      fo.restaurantid
  ),
  MappedOrderStats AS (
    SELECT
      ros.orderdate,
      CASE
        WHEN ros.original_country IN ('DET', 'DEL') THEN 'DE'
        WHEN ros.original_country = 'GB' THEN 'UK'
        ELSE ros.original_country
      END AS country,
      SUM(ros.all_jet_plus_orders) AS all_jet_plus_orders,
      SUM(ros.total_vouchercost) AS total_vouchercost
    FROM
      RawOrderStats AS ros
    GROUP BY
      1,
      2
  )
SELECT
  mos.country,
  mos.orderdate,
  mos.all_jet_plus_orders,
  mos.total_vouchercost
FROM
  MappedOrderStats AS mos

ORDER BY
  mos.country,
  mos.orderdate;
