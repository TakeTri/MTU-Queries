WITH DateRange AS (
  -- Define the start and end dates dynamically
  SELECT
    DATE_TRUNC(DATE_SUB(CURRENT_DATE(), INTERVAL 13 MONTH), MONTH) AS start_date, -- Start of Sept last year
    DATE_TRUNC(CURRENT_DATE(), MONTH) AS end_date -- Start of the current month (exclusive end)
),
CountryOrderStats AS (
  -- Aggregate core order and voucher stats by country and date
  SELECT
    CASE
      WHEN dcountry.country IN ('DET', 'DEL') THEN 'DE'
      WHEN dcountry.country = 'GB' THEN 'UK'
      ELSE dcountry.country
    END AS country,
    DATE_TRUNC(fo.orderdatetime, DAY) AS orderdate,
    COUNT(DISTINCT fo.orderid) AS orders,
    SUM(fo.gtv) AS GTV,
    SUM(ABS(fom.rpo_voucher_amount)) AS total_vouchercost,
    COUNTIF(fom.rpo_voucher_amount < 0) AS nr_vouchers_used
  FROM
    `just-data-warehouse.core_dwh.fact_order` AS fo
  CROSS JOIN DateRange -- Get the dynamic dates
  LEFT JOIN
    `just-data-warehouse.dwh.dim_country` AS dcountry ON dcountry.countryid = fo.countryid
  LEFT JOIN
    `just-data-warehouse.core_dwh.fact_order_margin` AS fom ON fo.orderid = fom.order_id
  WHERE
    -- Use the dynamic date range for partition elimination
    fo.orderdatetime >= DateRange.start_date
    AND fo.orderdatetime < DateRange.end_date
    -- Also apply to fom date if it uses the same partition key and is necessary
    AND fom.order_date_time_utc >= DateRange.start_date
    AND fom.order_date_time_utc < DateRange.end_date
  GROUP BY
    1, 2
),
AllJetPlusOrders AS (
  -- Aggregate JET+ orders separately by country and date
  SELECT
    CASE
      WHEN dcountry.country IN ('DET', 'DEL') THEN 'DE'
      WHEN dcountry.country = 'GB' THEN 'UK'
      ELSE dcountry.country
    END AS country,
    DATE_TRUNC(fo.orderdatetime, DAY) AS orderdate,
    COUNT(DISTINCT fo.orderid) AS all_jet_plus_orders
  FROM
    `just-data-warehouse.core_dwh.fact_order` AS fo
  CROSS JOIN DateRange -- Get the dynamic dates
  INNER JOIN
    `just-data-warehouse.dwh.dim_order` AS ddo ON fo.orderid = ddo.orderid
  INNER JOIN
    `just-data-warehouse.datamart_mis_jet_plus.jet_plus_active_memberships_v2` AS am ON ddo.global_user_id = am.global_user_id AND DATE(fo.orderdatetime) = am.snapshot_date
  LEFT JOIN
    `just-data-warehouse.dwh.dim_country` AS dcountry ON fo.countryid = dcountry.countryid
  WHERE
    -- Use the dynamic date range for partition elimination
    fo.orderdatetime >= DateRange.start_date
    AND fo.orderdatetime < DateRange.end_date
    -- Membership validity check
    AND fo.orderdatetime BETWEEN am.membership_start_date AND LEAST(am.membership_cancel_date, am.membership_expiry_date)
    -- Apply dynamic range to ddo.orderday if needed
    AND ddo.orderday >= DateRange.start_date
    AND ddo.orderday < DateRange.end_date
  GROUP BY
    1, 2
)
-- Final Select joining the two aggregations
SELECT
  cos.country,
  cos.orderdate,
  cos.orders,
  cos.GTV,
  COALESCE(ajpo.all_jet_plus_orders, 0) AS all_jet_plus_orders,
  cos.total_vouchercost,
  cos.nr_vouchers_used
FROM
  CountryOrderStats AS cos
LEFT JOIN
  AllJetPlusOrders AS ajpo ON cos.country = ajpo.country AND cos.orderdate = ajpo.orderdate
ORDER BY
  cos.country,
  cos.orderdate;
